const t="colorScheme",e="colorLinearRange",r={getDropdown(t,e){if(t&&t.length>0)return t;const r=[];return e.forEach(((t,e)=>{0!==e&&(t=>"Color"!==t&&"keyCategory"!==t)(t)&&r.push({data:t,display:t})})),r},getId:t=>t.replace(/ |-|\(|\)/g,"_"),getColorDomainRangeMax(r){const a=t=>r&&r[t],o=Array.isArray(r[e]),n=a(e)?o?Object.values(r[e]):Object.keys(r[e]).map((t=>parseInt(t))):[],s=a(e)?o?[]:Object.values(r[e]):[],l=r[t],i=r.colorMax||d3.max(n);return{colorDomain:n.map((t=>t/i)),colorRange:s&&s.length>0?s:l,colorMax:i}},getUserDefinedKeysColors(t){const e=[],r=[];return t.forEach((t=>{e.push(t.key?t.key:t.keyName),r.push(t.colour)})),{keys:e,colors:r}},getKeysColors({keys:e,userKey:r,option:a}){let o={keys:e};return r.length>=1?o=this.getUserDefinedKeysColors(r):a[t]&&(o.colors=a[t]),o},chartlines:t=>0==t.dropdown.length?t.keys:[t.xColumn,...t.dropdown[0].values.split(",").map((t=>t.trim()))],stackedhorizontal:t=>0==t.dropdown.length?t.keys.filter((e=>e!=t.yColumn)):t.dropdown[0].values.split(",").map((t=>t.trim())),stackedbars:t=>0==t.dropdown.length?t.keys.filter((e=>e!=t.xColumn)):t.dropdown[0].values.split(",").map((t=>t.trim())),smallmultiples:t=>0==t.dropdown.length?t.keys:[t.xColumn,t.groupBy,...t.dropdown[0].values.split(",").map((t=>t.trim()))]};var a={guardian:["#CC0A11","#046DA1","#f28e2c","#76b7b2","#59a14f","#edc949","#af7aa1","#ff9da7","#9c755f","#bab0ab","#000000"],guardian2:["rgb(204, 10, 17)","rgb(4, 109, 161)","#ff7f00","rgb(0, 178, 255)","rgb(245, 189, 44)","rgb(179, 179, 180)","rgb(128, 128, 128)","#000000"],darkmode:["#ffd700","#ea5f94","#13F4EF","#fa8775","#cd34b5","#9d02d7","#0000ff"],"the-crunch":["#ffd700","#ea5f94","#13F4EF","#fa8775","#cd34b5","#9d02d7","#0000ff"]};class o{constructor(t){const e=a.guardian,r="string"==typeof t,o=e=>!t||r?null:t[e],n=t?r?t:t.type:"ordinal",s=o("domain"),l=o("colors");switch(this.divisor=o("divisor"),n){case"linear":this.cScale=d3.scaleLinear().range(e);break;case"threshold":this.cScale=d3.scaleThreshold().range(e);break;case"quantile":this.cScale=d3.scaleQuantile().range(e);break;case"quantize":this.cScale=d3.scaleQuantize().range(e);break;default:this.cScale=d3.scaleOrdinal().range(e)}this.set(s,l)}get(t){const e=this.divisor?t/this.divisor:t;return this.cScale(e)}set(t,e){let r=!1,o=null;"string"==typeof e&&(a[e]?(o=a[e],r=!0):d3[e]?(o=d3[e],r=!0):console.error(`${e} is not part of the color presets or d3 scale chromatic colour scheme`)),Array.isArray(e)&&e.length>0&&(o=e,r=!0),r&&this.cScale.range(o),t&&t.length>0&&this.cScale.domain(t)}}function n(t,e,r=20){t.each((function(){let t,r=d3.select(this),a=r.text().split(/\s+/).reverse(),o=[],n=0,s=r.attr("y"),l=parseFloat(r.attr("dy")||0),i=r.text(null).append("tspan").attr("x",r.attr("x")).attr("y",s).attr("dy",l+"em");for(;t=a.pop();)o.push(t),i.text(o.join(" ")),i.node().getComputedTextLength()>e&&(o.pop(),i.text(o.join(" ")),o=[t],i=r.append("tspan").attr("x",r.attr("x")).attr("y",s).attr("dy",`${1.1*++n+l}em`).text(t))}))}function s(t,e,r,a,o,n=!1){if(t.select(`#${e.id}`).remove(),e.path||"true"==e.path)!function(t,e,r,a,o){const n=r-o.left-o.right,s=a-o.top-o.bottom,c=t.append("g").attr("transform",`translate(${o.left}, ${o.top})`).attr("id",e.id).attr("class","labelWrapper").style("opacity",0);c.append("path").attr("class","labelPath mobHide").attr("fill","none").attr("stroke","black").attr("stroke-width",2).attr("data-id",e.id).attr("d",l(n*e.coords.targetX,s*e.coords.targetY,n*e.coords.centreX,s*e.coords.centreY,n*e.coords.sourceX,s*e.coords.sourceY)),c.append("text").attr("class","labelText mobHide").attr("x",n*e.coords.textX).attr("y",s*e.coords.textY).attr("text-anchor",e.align).attr("data-id",e.id).text(e.text),t.selectAll(`#${e.id} text`).each(i),c.transition().style("opacity",1)}(t,e,r,a,o);else{var c=t.append("g").attr("id",e.id).attr("class","labelWrapper").attr("data-config",JSON.stringify(e)).style("opacity",0),d=function(t,e,r,a,o){console.log("margin",r,"width",a,"height",o),e.largeArcFlag||(e.largeArcFlag=0);e.sweepFlag||(e.sweepFlag=0);e.radius||(e.radius=75);var n=JSON.parse(JSON.stringify(e.coords));if(e.coordType&&("pct"===e.coordType||""===e.coordType)){t.select("g");var s=a-r.left-r.right,l=o-r.top-r.bottom;console.log("svgWidth",s,"svgHeight",l),n.sourceX=e.coords.sourceX*s+r.left,n.targetX=e.coords.targetX*s+r.left,n.sourceY=e.coords.sourceY*l+r.top,n.targetY=e.coords.targetY*l+r.top,n.textX=e.coords.textX*s+r.left,n.textY=e.coords.textY*l+r.top}var i=`M ${n.sourceX}, ${n.sourceY} A ${e.radius}, ${e.radius} 0 ${e.largeArcFlag},${e.sweepFlag} ${n.targetX}, ${n.targetY}`;return{curvePath:i,newCoords:n}}(t,e,o,r,a),p=d.curvePath,g=d.newCoords;if(t.append("svg:defs").append("svg:marker").attr("id","arrow").attr("refX",6).attr("refY",6).attr("markerWidth",30).attr("markerHeight",30).attr("markerUnits","userSpaceOnUse").attr("orient","auto").append("path").attr("d","M 0 0 12 6 0 12 3 6").style("fill","black"),c.append("path").attr("class","labelPath mobHide").attr("fill","none").attr("stroke","black").attr("stroke-width",2).attr("data-id",e.id).attr("marker-end",(()=>e.arrow&&"true"==e.arrow?"url(#arrow)":"none")).attr("d",p),n){var u=t.select(`#${e.id} .labelPath`).node(),f=u.getPointAtLength(u.getTotalLength()/2);c.append("circle").attr("fill","black").attr("stroke","black").attr("class","clickControl").attr("r",5).attr("data-id",e.id).attr("cx",f.x).attr("cy",f.y)}c.append("text").attr("class","labelText mobHide").attr("text-anchor",(()=>e.align?e.align:"start")).attr("x",g.textX).attr("y",g.textY).attr("dy",15).attr("data-id",e.id).attr("dx",0).attr("fill","black").text(e.text),t.selectAll(`#${e.id} text`).each(i),n&&function(t,e,r,a,o){console.log("click");var n=0,l=null,i="svg",c={targetX:0,targetY:0,sourceX:0,sourceY:0,textX:0,textY:0},d=t.selectAll(".clickControl");d.on("click",(function(t){n-=1,l=d3.select(this).attr("data-id"),d3.select(`#${l} .clickControl`).transition().attr("opacity",.2),d3.select(`#${l} .labelPath`).transition().attr("opacity",.2),i="path"}));var p=t.selectAll(".labelText");p.on("click",(function(t){n-=1,l=d3.select(this).attr("data-id"),d3.select(this).transition().attr("opacity",.2),i="label"})),t.on("click",(function(d){console.log("clicktype",i,"clickNo",n),console.log("clickPos",d3.pointer(event)[0],d3.pointer(event)[1],"modifiedPos",d3.pointer(event)[0]-a.left,d3.pointer(event)[1]-a.top),console.log("clickPos",d3.pointer(event)[0],d3.pointer(event)[1],"modifiedPos",d3.pointer(event)[0]-a.left,d3.pointer(event)[1]-a.top);var p=(d3.pointer(event)[0]-a.left)/(e-a.left-a.right),g=(d3.pointer(event)[1]-a.top)/(r-a.top-a.bottom);if(console.log("clickXpct",p,"clickYpct",g),-1==n)n+=1;else if(0==n){if(n+=1,c.targetX=p,c.targetY=g,"label"===i&&null!=l){var u=JSON.parse(t.select(`#${l}`).attr("data-config"));console.log("newConfig",u),l=null,c.textX=p,c.textY=g,u.coords.textX=c.textX,u.coords.textY=c.textY,s(t,u,e,r,a,o),console.log(JSON.stringify(u.coords))}}else if(1===n&&(n=0,null!=l)){u=JSON.parse(t.select(`#${l}`).attr("data-config"));console.log("newConfig",u),l=null,"path"===i&&(c.sourceX=p,c.sourceY=g,u.coords.sourceX=c.sourceX,u.coords.sourceY=c.sourceY,u.coords.targetX=c.targetX,u.coords.targetY=c.targetY),s(t,u,e,r,a,o),console.log(JSON.stringify(u.coords))}}))}(t,r,a,o,n),c.transition().style("opacity",1)}}const l=(t,e,r,a,o,n)=>`M ${t} ${e} Q ${r} ${a} ${o} ${n}`,i=function(){var t=d3.select(this),e=t.text().split("\n");t.text("");for(var r=0;r<e.length;r++){var a=t.append("tspan").text(e[r]);r>0&&a.attr("x",t.attr("x")).attr("dy","15")}};class c{constructor(t){this.settings=t,this.init()}init(){var t,e,r;console.log("enableshowmore",this.settings.enableShowMore),t=this.settings.enableShowMore,e=document.querySelector("#button2"),r=document.querySelector("#outer-wrapper"),t?(console.log("Activate"),e.addEventListener("click",(function(){r.classList.toggle("min"),document.getElementById("showbutton").classList.toggle("hide"),document.getElementById("hidebutton").classList.toggle("hide")})),r.classList.toggle("min")):(console.log("Do not Activate"),null!=e&&e.remove()),this.render()}render(){let{modules:t,type:e,colors:a,height:l,width:i,featuresWidth:c,featuresHeight:d,svgWidth:p,svgHeight:g,isMobile:u,title:f,subtitle:h,source:x,marginleft:y,margintop:m,marginbottom:k,marginright:b,tooltip:v,data:w,datum:S,labels:C,userkey:X,keys:$,rowHeight:Y,enableShowMore:A,colorScheme:F,dropdown:O,groupBy:M,minX:T,maxX:N,xFormat:E,xScale:L,yScale:P,parseTime:J,xAxisLabel:H,xColumn:D}=this.settings;d3.select("#graphicContainer svg").remove();const W=d3.select("#chartKey");W.html(""),S=JSON.parse(JSON.stringify(w)),a=new o,u=Math.max(document.documentElement.clientWidth,window.innerWidth||0)<610;const K=r.getKeysColors({keys:$,userKey:X,option:{colorScheme:F}});a.set(K.keys,K.colors),p=document.querySelector("#graphicContainer").getBoundingClientRect().width,g=S.length*Y+m+k,c=p-b-y,d=g-m-k;let B=$.filter((t=>"Color"!=t&&t!=M)),U=[];S.forEach((function(t){E.date&&B.forEach((e=>{var r,a;r=B,a=e,(Array.isArray(a)?a.some((t=>r.indexOf(t)>-1)):r.indexOf(a)>-1)&&(t[e]=J(t[e]))}))}));for(var j=0;j<S.length;j++)B.forEach((t=>{U.push(S[j][t])}));let q=d3.extent(U);const z=function(t){let e=d3.extent(t),r=0,a=e[1],o=!1;return e[0]<0&&(e[0]=Math.floor(e[0]),e[1]=Math.ceil(e[1]),a=Math.abs(e[0])>e[1]?Math.abs(e[0]):e[1],r=-a,o=!0),{min:r,max:a,status:o}}(U.map((t=>t)));let I=function(t,e,r=5){const a=(e-t)/100*r;return[t-a,e+a]}(q[0],q[1],15);T=isNaN(T)?+T:I[0],N=isNaN(N)?+N:I[1];const R=d3.select("#graphicContainer").append("svg").attr("width",p).attr("height",g).attr("id","svg").attr("overflow","hidden"),G=R.append("g").attr("transform","translate("+y+","+m+")");var Q=d3[L]();Q.range([0,c]),G.append("g").attr("transform","translate(0,"+g+")").call(d3.axisBottom(Q));var _=d3[P]().range([0,d]).domain(S.map((function(t){return t[M]}))).padding(1);if(E.date?Q.domain(d3.extent(U)):Q.domain([T,N]),2==B.length){let t=a.get(B[0]),e=a.get(B[1]);G.selectAll("lines").data(S).enter().append("line").attr("x1",(function(t){return Q(+t[B[0]])})).attr("x2",(function(t){return Q(+t[B[1]])})).attr("y1",(function(t){return _(t[M])})).attr("y2",(function(t){return _(t[M])})).attr("stroke",(function(r,a){let o=Q(+r[B[0]]),n=Q(+r[B[1]]),s=o<n?t:e,l=n>o?e:t,i=o<n?o:n,c=n>o?n:o,d=R.append("defs").append("linearGradient").attr("id",`svgGradient_${a}`).attr("gradientUnits","userSpaceOnUse").attr("x1",i).attr("x2",c).attr("y1",_(r[M])).attr("y2",_(r[M])+10);return d.append("stop").attr("class","start").attr("offset","0%").attr("stop-color",s).attr("stop-opacity"),d.append("stop").attr("class","end").attr("offset","100%").attr("stop-color",l).attr("stop-opacity",1),`url(#svgGradient_${a})`})).style("stroke-width","6px")}1==B.length?(G.selectAll("lines").data(S).enter().append("line").attr("x1",(function(t){return Q(0)})).attr("x2",(function(t){return Q(+t[B[0]])})).attr("y1",(function(t){return _(t[M])})).attr("y2",(function(t){return _(t[M])})).style("stroke",((t,e)=>t.Color?t.Color:a.get(t[B[0]]))).style("stroke-width","4px"),G.selectAll(".barText").data(S).enter().append("text").attr("class","barText").attr("x",(function(t){let e=t[B[0]]<0?-6:6;return Q(0)+e})).attr("text-anchor",(function(t){return t[B[0]]>0?"start":"end"})).attr("y",(function(t){return _(t[M])-Y/3.5})).text((t=>t[M])),T<0&&N>0&&G.append("line").attr("x1",(function(t){return Q(0)})).attr("x2",(function(t){return Q(0)})).attr("y1",(function(t){return 0})).attr("y2",(function(t){return d})).style("stroke","#767676").style("stroke-width","1px")):G.selectAll(".barText").data(S).enter().append("text").attr("class","barText").attr("x",(function(t){let e=[];for(var r=0;r<B.length;r++)e.push(t[B[r]]);return Q(d3.min(e))-20})).attr("text-anchor",(function(t){return z.status?"start":"end"})).attr("y",(function(t){return _(t[M])+3})).text((t=>t[M]));for(const t of B)G.selectAll(".lolly").data(S).enter().append("circle").attr("cx",(function(e){return Q(+e[t])})).attr("cy",(function(t){return _(t[M])})).attr("r","7").style("fill",((e,r)=>e.Color?e.Color:a.get(t))).style("stroke",((e,r)=>e.Color?e.Color:a.get(t)));const V=function(t,e,r){if(t)return 4;let a=Math.round(e[1]-e[0]),o=Math.round(r/100);return o>a?a:o}(u,Q.domain(),c);if(G.append("g").attr("class","x").attr("transform","translate(0,"+g+")").call((t=>t.attr("transform",`translate(0,${m})`).attr("class","axisgroup").call(d3.axisTop(Q).tickSizeOuter(0)).call(d3.axisTop(Q).tickSize(-g,0,0).ticks(V).tickFormat((t=>E.date?d3.timeFormat("%b %Y")(t):function(t){if(t>0)return t>=1e9?t/1e9%1==0?t/1e9+"bn":(t/1e9).toFixed(1)+"bn":t>=1e6?t/1e6%1==0?t/1e6+"m":(t/1e6).toFixed(1)+"m":t>=1e3?t/1e3%1==0?t/1e3+"k":(t/1e3).toFixed(1)+"k":t;if(t<0){var e=-1*t;return e>=1e9?["-"+String((e/1e9).toFixed(1))+"bn"]:e>=1e6?["-"+String((e/1e6).toFixed(1))+"m"]:e>=1e3?["-"+String((e/1e3).toFixed(1))+"k"]:t}return t}(t))).tickPadding(10)))),B.length>1&&B.forEach(((t,e)=>{const r=W.append("div").attr("class","keyDiv");r.append("span").attr("class","keyCircle").style("background-color",(()=>a.get(t))),r.append("span").attr("class","keyText").text(t)})),H&&R.append("text").attr("x",y).attr("y",m).attr("fill","#767676").attr("text-anchor","end").text(H).call(n,y),(z.status||Q(0)>y)&&G.append("line").style("stroke","#767676").style("stroke-width",1).attr("x1",Q(0)).attr("y1",0).attr("x2",Q(0)).attr("y2",d),C.length>0){const t=!!function(t){var e="";e=top!==self?window.location.search.substring(1).split("&"):window.parent.location.search.substring(1).split("&");for(let r=0;r<e.length;r++){let a=e[r].split("=");if(a[0]==t)return a[1]}return null}("labelling");console.log("clickLoggingOn",t),"string"==typeof C[0].coords&&C.forEach((function(t){t.coords=JSON.parse(t.coords),t.sweepFlag=+t.sweepFlag,t.largeArcFlag=+t.largeArcFlag,t.radius=+t.radius})),console.log("annotations",C),C.forEach((e=>{s(R,e,p,g,{left:y,right:b,top:m,bottom:k},t)}))}}}export{c as default};
